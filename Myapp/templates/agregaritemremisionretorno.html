{% load static %}
{% load crispy_forms_tags %}
<html>
<head>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
    <link rel="" href="https://cdn.datatables.net/fixedheader/3.1.6/css/fixedHeader.dataTables.min.css">
    <title>Ingresar item remision</title>
    <h1> Agregar repuesto a remision</h1>
    <p></p>
    <style>
    form {
            margin: 20px; /* Aade margen alrededor del formulario */
            padding: 20px; /* Aade espacio interno al formulario */
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Estilo para los campos de entrada */
        .form-control {
            margin-bottom: 10px;
            /* Otros estilos personalizados segn tus preferencias */
        }
    </style>

</head>
<body>
<form action="{% url 'guardaritemremisionretorno' %}" method="POST" onsubmit="capturarValorCheckbox()">
    {% csrf_token %}
    <input type="hidden" class="form-control" id="inputremision" name="itemremision" value="{{remision.id}}" readonly>
    <div class="row">

    <div class="col-md-2">
        <label for="inputserial" class="form-label">* # Serie PMV a:</label>
        <select class="form-select" id="inputserial" name="serial" required>
            <option value="" disabled selected>Seleccione serial..</option>
            {% for maquina in seriales_relacionados %}
                <option value="{{ maquina.id }}" data-sala="{{ maquina.salas.nombre }}" data-sala2="{{ maquina.salas }}" data-inspired="{{ maquina.id_inspired }}" data-posicion="{{ maquina.id_posicion }}" >{{ maquina.serie_PMV }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-5">
        <label for="inputcliente" class="form-label">Cliente:</label>
        <input type="text" class="form-control" id="inputcliente" name="cliente" value="{{cliente.nombre}}" readonly>
    </div>
    <div class="col-md-5">
        <label for="inputsala" class="form-label">Sala:</label>
        <input type="text" class="form-control" id="inputsala" name="sala" readonly>
        <input type="hidden" class="form-control" id="inputsala2" name="salaoculto" readonly>
    </div>
    <div class="col-md-2">
        <label for="inputinspired" class="form-label">ID Inspired:</label>
        <input type="text" class="form-control" id="inputinspired" name="inspired" readonly>
    </div>
    <div class="col-md-2">
        <label for="inputposicion" class="form-label">Posición:</label>
        <input type="text" class="form-control" id="inputposicion" name="posicion" readonly>
    </div>
<p></p>
        <div class="col-md-4">
            <label for="inputrepuesto" class="form-label">* Repuesto:</label>
            <select class="form-select" id="inputrepuesto" name="repuesto" required>
                <option value="" disabled selected>Seleccione repuesto...</option>
                {% for repuestos in lista_repuestos %}
                <option value="{{ repuestos.id }}">{{ repuestos.nombre }}</option>
                {% endfor %}
                <!--<option value="otros">Otros</option>-->
            </select>
        </div>
        <p></p>
        <!--<div class="col-md-2">
            <label for="inputcual" class="form-label">Cual:</label>
            <input type="text" class="form-control" name="cual" id="inputcual" disabled>
        </div>--!>
        <div class="col-md-4">
            <label for="inputserialrepuestodespacho" class="form-label">* Serial Rep. Despacho:</label>
            <div id="serial-despacho-container">
                <input type="text" class="form-control" id="inputserialrepuestodespacho" name="serialrepuestodespacho"
                       required>
            </div>

    <div class="col-md-3">
        <label for="inputfecharetorno" class="form-label">* Fecha Ingreso Repuesto:</label>
        <input type="date" class="form-control" name="fecharetorno" id="inputfecharetorno" required>
    </div>
    <p></p>

    </div>
    <P></P>
    <CENTER>
    <button type="submit" class="btn btn-info">Guardar</button>
    <button type="button" class="btn btn-info" id="cerrarVentana">Cerrar</button>
    </CENTER>

</form>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para capturar el valor del checkbox
        function capturarValorCheckbox() {
            var checkbox = document.getElementById("miCheckbox");
            var valor = checkbox.checked ? 1 : 0;
            document.getElementById("ums").value = valor;
        }

        // Cerrar la ventana
        document.getElementById('cerrarVentana').addEventListener('click', function() {
            window.close();
        });

        // Evento change para el select de código de máquina
        const selectCodigoMaquina = document.getElementById("inputserial");
        const inputsala = document.getElementById("inputsala");
        const inputsala2 = document.getElementById("inputsala2");
        const datainspired = document.getElementById("inputinspired");
        const dataposicion = document.getElementById("inputposicion");

        selectCodigoMaquina.addEventListener("change", function() {
            const selectedOption = selectCodigoMaquina.options[selectCodigoMaquina.selectedIndex];
            inputsala.value = selectedOption.getAttribute("data-sala") || '';
            inputsala2.value = selectedOption.getAttribute("data-sala2") || '';
            datainspired.value = selectedOption.getAttribute("data-inspired") || '';
            dataposicion.value = selectedOption.getAttribute("data-posicion") || '';
        });

        // Escuchar mensajes del evento window
        window.addEventListener("message", function(event) {
            if (event.data) {
                alert(event.data);
            }
        });

        // Evento change para el select de repuesto
        const selectRepuesto = document.getElementById("inputrepuesto");
        const inputCual = document.getElementById("inputcual");
        const serialDespachoContainer = document.getElementById("serial-despacho-container");

        selectRepuesto.addEventListener("change", function() {
            const selectedRepuestoId = selectRepuesto.value;
            console.log('Selected Repuesto ID:', selectedRepuestoId); // Aquí imprime el ID seleccionado

            if (selectedRepuestoId) {
                fetch(`/obtener_seriales_repuesto/${selectedRepuestoId}/`)  // Agrega las comillas alrededor de la URL
                    .then(response => response.json())
                    .then(data => {
                        if (data.seriales && data.seriales.length > 0) {
                            const selectElement = document.createElement('select');
                            selectElement.className = 'form-select';
                            selectElement.id = 'inputserialrepuestodespacho';
                            selectElement.name = 'serialrepuestodespacho';
                            selectElement.required = true;

                            data.seriales.forEach(serial => {
                                const option = document.createElement('option');
                                option.value = serial.serial;
                                option.textContent = serial.serial;
                                selectElement.appendChild(option);
                            });

                            // Reemplazar el contenido del contenedor
                            serialDespachoContainer.innerHTML = '';
                            serialDespachoContainer.appendChild(selectElement);
                        } else {
                            // Si no hay seriales disponibles, mostrar un input de texto
                            serialDespachoContainer.innerHTML =
                                '<input type="text" class="form-control" id="inputserialrepuestodespacho" name="serialrepuestodespacho" required>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching seriales:', error);
                        // Mostrar un mensaje de error o manejar el error según sea necesario
                    });
            } else {
                // Si no se seleccionó ningún repuesto, mostrar un input de texto requerido
                serialDespachoContainer.innerHTML =
                    '<input type="text" class="form-control" id="inputserialrepuestodespacho" name="serialrepuestodespacho" required>';
            }
        });
    });
</script>
<p style="color: red; font-weight: bold;">Los campos marcados con * son obligatorios.</p>
<center>
    <fieldset>
        <div id="version">
            <h6>Ver. Verisón 1.0.0 (01/04/2022)</h6>
            <img src="{% static "img/logosistema.png" %}" > <br>
            <h8>Copyright ® 2019</h8>
            <br>
            <h8>SPOTGAMING S.A.S</h8>
            <br>
        </div>
    </fieldset>
</center>
</body>
</html>