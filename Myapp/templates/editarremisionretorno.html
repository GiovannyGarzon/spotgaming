{% extends 'menualmacen.html' %}
{% load crispy_forms_tags %}
{% block content%}

<h1> Datos de Retorno de Remisión </h1>
<p></p>

<form class="row g-3" action="{% url 'formeditarremsiionretorno' %}" method="POST">
  {% csrf_token %}
  <div class="col-md-4">
    <label for="inputnumeroremvisible" class="form-label">Numero_REM:</label>
    <input type="texto" class="form-control" id="inputnumeroremvisible" name="numerorem" value="REM-00{{remision.id}}" readonly onmousedown="return false;">
    <input type="hidden" class="form-control" id="inputnumerorem" name="numerorem" value="{{remision.id}}" readonly onmousedown="return false;">
  </div>
  <div class="col-md-4">
    <label for="inputfecharemision" class="form-label">Fecha Remisión:</label>
    <input type="date" class="form-control" id="inputfecharemision" name="fecharemi" value="{{remision.fecha|date:"Y-m-d"}}" required>
  </div>
  <div class="col-md-4">
    <label for="inputclienteremi" class="form-label">Cliente:</label>
    <input type="texto" class="form-control" id="inputclienteremi" name="cliente" value="{{remision.cliente.nombre}}">
    <input type="hidden" name="clienteoculto" value="{{remision.cliente}}">
  </div>
  <div class="col-md-2">
    <label for="inputfecharecibido" class="form-label">Fecha Recibido :</label>
    <input type="date" class="form-control" id="inputfecharecibido" name="fecharecibido" value="{{remision.fecha_recibido|date:"Y-m-d"}}">
  </div>
  <div class="col-md-2">
    <label for="inputformaenvio" class="form-label">Forma de Envío:</label>
    <select id="inputformaenvio" class="form-select" name="formaenvio" required>
      {% if remision.id_transporte %}
        <option value="{{ remision.id_transporte.id }}" selected>{{ remision.id_transporte.nombre }}</option>
          {% for Transporte in transportes %}
            {% if Transporte.id != remision.id_transporte.id %}
            <option value="{{ Transporte.id }}">{{ Transporte.nombre }}</option>
            {% endif %}
          {% endfor %}
          {% else %}
            <option value="" selected>Formas de envio...</option>
            {% for Transporte in transportes %}
            <option value="{{ Transporte.id }}">{{ Transporte.nombre }}</option>
          {% endfor %}
      {% endif %}
    </select>
  </div>
  <div class="col-md-2">
    <label for="inputrecibido" class="form-label">Recibido por:</label>
    <input type="text" class="form-control" id="inputrecibido" name="recibido" value="{{remision.elaborado}}" readonly onmousedown="return false;">
  </div>
  <div class="col-md-4">
    <label for="inputguia" class="form-label"># Guia de Envío:</label>
    <input type="text" class="form-control" id="inputguia" name="guiaremi" value="{{remision.guia}}" REQUIRED>
  </div>
  <div class="col-md-2">
    <label for="inputstatus" class="form-label">Status:</label>
    <select id="inputstatus" class="form-select" name="statusremi" required>
        <!-- Mostrar el status actual como la opción seleccionada -->
        <option value="{{ current_status.id }}" selected>
            {{ current_status.nombre }}
        </option>
        <!-- Mostrar las demás opciones -->
        {% for option in status_options %}
            {% if option.id != current_status.id %}  <!-- Evitar mostrar el estado actual en las opciones -->
                <option value="{{ option.id }}">
                    {{ option.nombre }}
                </option>
            {% endif %}
        {% endfor %}
    </select>
  </div>
  <br>
  <table border="0" width="98%" id="table2" cellspacing="1" cellpadding="0" style="border: 1px solid #000000; padding-left:0; padding-right:0">
    <tbody>
    <tr>
      <td bgcolor="#808080" align="center">
        <b><font face="Tahoma" size="2" color="#FFFFFF">Detalle de la Remisión</font></b>
      </td>
    </tr>
    </tbody>
  </table>
  <table class="table table-bordered">
    <thead>
      <tr>
        <!--<th scope="col">ID</th>--!>
        <th scope="col" class="text-center">ID</th>
        <th scope="col" class="text-center">Descripcion de la Pieza / Parte</th>
        <th scope="col" class="text-center"># Serie Ret.</th>
        <th scope="col" class="text-center">#Fecha Retorno</th>
        <!--<th scope="col" class="text-center">Opciones</th>--!>
      </tr>
    </thead>
    <tbody>
      {% for item in items_remision %}
      <tr>
        <td class="text-center">ITEM00-{{ item.id }}</td>
        <td class="text-center">{{ item.repuesto.nombre }}</td>
        <td class="text-center">{{ item.serialrepuestoretorno }}</td>
        <td class="text-center">{{ item.fecharetorno }}</td>
        <!--<td class="text-center">
          <button type="button" class="btn btn-danger btnEditarItemRemision" data-itemremision-id="{{ item.id }}">Editar</button> | <button type="button" class="btn btn-danger">Ver</button>
        </td>--!>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <p></p>
  <div class="col-md-12">
    <label for="inputobservacion" class="form-label">Observación:</label>
    <textarea class="form-control" id="inputobservacion" name="observacion" rows="4" readonly>{{ remision.observacion }}</textarea>
  </div>
  <p></p>
  <center>
    <fieldset id="borde2">
      <button type="button" class="btn btn-info" id="btnAgregarItem" data-remision-id="{{ remision.id }}">Agregar Item</button>
      <!--<a type="button" class="btn btn-info">Agregar Reparación</a>--!>
      <a type="button" class="btn btn-info">Carta</a>
      <button type="button" class="btn btn-info" onclick="window.print();">Imprimir</button>
      <button type="submit" class="btn btn-info">Guardar</button>
      <a href="{% url 'retornoremision'%}" type="button" class="btn btn-info">Cerrar</a>
    </fieldset>
  </center>
</form>

<script>
document.getElementById('btnAgregarItem').addEventListener('click', function () {
        // Obtener el id de la remisión desde el atributo data
        var remisionId = this.getAttribute('data-remision-id');

        // Especifica la URL que deseas abrir en la ventana emergente
        var url = '/agregaritemremisionretorno/?remision_id=' + remisionId;

        // Abre la URL en una nueva ventana con las dimensiones deseadas
        var popup = window.open(url, 'agregaritemremision', 'width=400,height=550');

        // Puede ser útil darle el foco a la nueva ventana emergente
        if (popup) {
            popup.focus();
        }
    });

    document.addEventListener('click', function (event) {
    // Verificar si el clic proviene de un botón con la clase "btnEditarItemRemision"
    if (event.target.classList.contains('btnEditarItemRemision')) {
        // Obtener el id del itemremision desde el atributo data
        var itemremisionId = event.target.getAttribute('data-itemremision-id');

        // Construir la URL para editar el itemremision
        var url = '/editaritemremision/' + itemremisionId + '/';

        // Aquí debes abrir tu ventana modal con la URL
        // Puedes usar un enfoque específico de tu aplicación para abrir la modal

        // Ejemplo genérico usando una ventana emergente
        var popup = window.open(url, 'editaritemremision', 'width=1000,height=550');

        // Puede ser útil darle el foco a la nueva ventana emergente
        if (popup) {
            popup.focus();
        }
    }
});

    document.getElementById('btnImprimir').addEventListener('click', function() {
        window.print();
    });
</script>
{% endblock%}