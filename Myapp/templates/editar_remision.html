{% extends 'menualmacen.html' %}
{% load crispy_forms_tags %}
{% block content%}

<h1> Datos de la Orden de Remisión </h1>
<p></p>
{% if messages %}

<div class = "alert alert-success">
    <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}
<form class="row g-3" action="{% url 'formeditarremsiion' %}" method="POST">
  {% csrf_token %}
  <div class="col-md-4">
    <label for="inputnumerorem" class="form-label">Numero_REM:</label>
    <input type="texto" class="form-control" id="inputnumerorem" name="numerorem" value="REM00-{{remision.id}}" readonly onmousedown="return false;"  >
  </div>
  <input type="hidden" class="form-control" id="inputnumero" name="numero" value="{{remision.id}}" readonly onmousedown="return false;">
  <div class="col-md-4">
    <label for="inputfecharemision" class="form-label">Fecha Remisión:</label>
    <input type="date" class="form-control" id="inputfecharemision" name="fecharemi" readonly onmousedown="return false;" value="{{remision.fecha|date:"Y-m-d"}}" required>
  </div>
  <!--
  <div class="col-md-4">
    <label for="inputfechaenvio" class="form-label">Fecha Envio:</label>
    <input type="date" class="form-control" id="inputfechaenvio" name="fechaenvio" value="{{remision.fecha_envio}}" >
  </div> --!>
  <div class="col-md-4">
    <label for="inputclientes" class="form-label">Cliente:</label>
    <input type="texto" class="form-control" id="inputclientesocultos" name="clienteoculto" value="{{remision.clientes.nombre}}" readonly onmousedown="return false;">
  </div>
  <input type="hidden" class="form-control" id="inputclientes" name="clienteremi" value="{{remision.clientes}}" readonly onmousedown="return false;">
  <div class="col-md-4">
    <label for="inputenviadoa" class="form-label">Enviado a:</label>
    <input type="text" class="form-control" id="inputenviadoa" name="enviadoa" value="{{remision.contacto}}" required>
  </div>
  <!--
  <div class="col-md-2">
    <label for="inputfecharecibido" class="form-label">Fecha Recibido:</label>
    <input type="date" class="form-control" id="inputfecharecibido" name="fecharecibido" value="{{remision.fecha_recibido|date:"Y-m-d"}}" >
  </div> --!>

  <div class="col-md-2">
    <label for="inputtelefonoa" class="form-label">Teléfono:</label>
    <input type="text" class="form-control" id="inputtelefonoa" name="telefonoremi" value="{{remision.telefono}}">
  </div>
  <div class="col-md-2">
    <label for="inputfechaenvio" class="form-label">Fecha Envio:</label>
    <input type="date" class="form-control" id="inputfechaenvio" name="fechaenvio" value="{% if remision.fecha_envio %}{{ remision.fecha_envio|date:"Y-m-d" }}{% endif %}">
</div>
  <div class="col-md-2">
	<label for="inputformaenvio" class="form-label">Forma de Envío:</label>
	<input type="texto" class="form-control" id="inputformaenvio" name="formaenviooculto" value="{{remision.id_transporte}}" readonly onmousedown="return false;">
  </div>
  <input type="hidden" class="form-control" id="inputformaenvioocultos" name="formaenvio" value="{{remision.id_transporte.id}}" readonly onmousedown="return false;">
  <div class="col-md-2">
    <label for="inputpreparado" class="form-label">Preparado por:</label>
    <input type="text" class="form-control" id="inputpreparado" name="preparadaremi" value="{{remision.elaborado}}" readonly onmousedown="return false;">
  </div>
  <div class="col-md-6">
    <label for="inputguia" class="form-label"># Guia de Envío:</label>
    <input type="text" class="form-control" id="inputguia" name="guiaremi" value="{{remision.guia}}">
  </div>
  <div class="col-md-2">
    <label for="inputstatus" class="form-label">Status:</label>
    <select id="inputstatus" class="form-select" name="statusremi" required>
        {% for option in status_options %}
            <option value="{{ option.id }}" {% if option.id == remision.id_status.id %}selected{% endif %}>
                {{ option.nombre }}
            </option>
        {% endfor %}
    </select>
  </div>
  <table border="0" width="98%" id="table2" cellspacing="1" cellpadding="0" style="border: 1px solid #000000; padding-left:0; padding-right:0">
    <tbody>
    <tr>
      <td bgcolor="#808080" align="center">
        <b><font face="Tahoma" size="2" color="#FFFFFF">Detalle de la Remisión</font></b>
      </td>
    </tr>
    </tbody>
  </table>
  <table class="table table-bordered">
    <thead>
      <tr>
        <!--<th scope="col">ID</th>--!>
        <th scope="col" style="text-align: center;">ID</th>
        <th scope="col" style="text-align: center;"># Serie PMV</th>
        <th scope="col" style="text-align: center;">Sala</th>
        <th scope="col" style="text-align: center;">Descripcion de la Pieza / Parte</th>
        <th scope="col" style="text-align: center;"># Serie Env.</th>
        <th scope="col" style="text-align: center;">#Fecha Despacho</th>
        <th scope="col" WIDTH="150" style="text-align: center;">Opciones</th>
      </tr>
    </thead>
    <tbody>
    {% for item in items_remision %}
    <tr>
      <td class="text-center">ITEM00-{{ item.id }}</td>
      <td class="text-center">{{ item.codigomaquina.serie_PMV }}</td>
      <td class="text-center">{{ item.sala.nombre }}</td>
      <td class="text-center">{{ item.repuesto.nombre }}</td>
      <td class="text-center">{{ item.serialrepuestodespacho }}</td>
      <td class="text-center">{{ item.fechadespacho }}</td>
      <td>
        <button type="button" class="btn btn-danger btnEditarItemRemision" data-itemremision-id="{{ item.id }}">Editar</button> | <button type="button" class="btn btn-danger">Ver</button>
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  <p></p>
  <div class="col-md-12">
    <label for="inputobservacion" class="form-label">Observación:</label>
    <textarea class="form-control" id="inputobservacion" name="observacion" rows="4" readonly onmousedown="return false;">{{ remision.observacion }}</textarea>
  </div>
  <p></p>
  <center>
    <fieldset id="borde2">
      <button type="button" class="btn btn-info" id="btnAgregarItem" data-remision-id="{{ remision.id }}">Agregar Item</button>
      <a type="button" class="btn btn-info">Agregar Reparación</a>
      <button type="button" class="btn btn-info" onclick="window.print();">Imprimir</button>
      <a href="{% url 'generar_pdf' remision.id %}" class="btn btn-info" target="_blank">Carta</a>
      <button type="submit" class="btn btn-info">Guardar</button>
      <a href="{% url 'listaremisiones' %}" type="button" class="btn btn-info">Cerrar</a>
    </fieldset>
  </center>
</form>

<script>
  document.getElementById('btnAgregarItem').addEventListener('click', function () {
        // Obtener el id de la remisión desde el atributo data
        var remisionId = this.getAttribute('data-remision-id');

        // Especifica la URL que deseas abrir en la ventana emergente
        var url = '/agregaritemremision/?remision_id=' + remisionId;

        // Abre la URL en una nueva ventana con las dimensiones deseadas
        var popup = window.open(url, 'agregaritemremision', 'width=800,height=550');

        // Puede ser útil darle el foco a la nueva ventana emergente
        if (popup) {
            popup.focus();
        }
    });

    document.addEventListener('click', function (event) {
    // Verificar si el clic proviene de un botón con la clase "btnEditarItemRemision"
    if (event.target.classList.contains('btnEditarItemRemision')) {
        // Obtener el id del itemremision desde el atributo data
        var itemremisionId = event.target.getAttribute('data-itemremision-id');

        // Construir la URL para editar el itemremision
        var url = '/editaritemremision/' + itemremisionId + '/';

        // Aquí debes abrir tu ventana modal con la URL
        // Puedes usar un enfoque específico de tu aplicación para abrir la modal

        // Ejemplo genérico usando una ventana emergente
        var popup = window.open(url, 'editaritemremision', 'width=1000,height=550');

        // Puede ser útil darle el foco a la nueva ventana emergente
        if (popup) {
            popup.focus();
        }
    }
});

    document.getElementById('btnImprimir').addEventListener('click', function() {
        window.print();
    });
</script>
{% endblock%}